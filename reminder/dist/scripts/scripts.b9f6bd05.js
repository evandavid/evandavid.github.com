"use strict";angular.module("angularApp",["ngSanitize","ui.router","LocalStorageModule","restangular"]).config(["localStorageServiceProvider","RestangularProvider","$httpProvider",function(a,b,c){var d=window.location.hostname;d="localhost"===d?"":d,a.setPrefix("angular").setStorageType("sessionStorage").setStorageCookieDomain(d),b.setBaseUrl("http://expressnode.azurewebsites.net/api"),c.interceptors.push("APIInterceptor")}]).service("APIInterceptor",["$rootScope","localStorageService","$q","$injector",function(a,b,c,d){var e=this;e.request=function(d){d.params||(d.params={});var e=null;return e=null===a.token||void 0===a.token?b.get("token"):a.token,d.params.token=e,d||c.when(d)},e.responseError=function(a){return 401===a.status||403===a.status?(b.set("token",null),d.get("$state").transitionTo("auth"),c.reject(a)):c.reject(a)},e.response=function(a){return a}}]).run(["$rootScope","$state","$stateParams","Authorization","Cancan","$window",function(a,b,c,d,e,f){a.$on("$stateChangeStart",function(b,c,f){a.toState=c,a.toStateParams=f,a.search=null,a.page=1,e.isIdentityResolved()&&d.authorize()}),a.$on("$stateChangeSuccess",function(){f.scrollTo(0,0)})}]),angular.module("angularApp").controller("AuthCtrl",["$rootScope","Authentication","localStorageService","$state",function(a,b,c,d){function e(){h.logginIn=!h.logginIn}function f(){c.get("token")&&d.go("app.restricted.dashboard")}function g(){e(),h.errorLogin=null,b.authenticate(h.user).then(function(b){a.token=b.token,c.set("token",b.token),console.clear(),d.go("app.restricted.dashboard"),e()},function(a){h.errorLogin=a.data.message,e()})}var h=this;f(),h.doLogin=g}]),angular.module("angularApp").controller("MainCtrl",["$rootScope","currentUser","localStorageService","$state",function(a,b,c,d){a.currentUser=b,a.logout=function(){c.set("token",null),d.go("auth")},a.pageCount=function(a){return Math.ceil(a/10)},a.range=function(a,b,c){c=c||1;for(var d=[],e=a;b>=e;e+=c)d.push(e);return d}}]),angular.module("angularApp").controller("UsersCtrl",["User","Role","$timeout",function(a,b,c){function d(){n.filter={},n.filter.name="",n.filter.username=""}function e(){n.showForm=!0,n.formError=null,n.formSuccess=null}function f(){e()}function g(){n.showForm=!1,n.selectedUser={},n.processing=!1}function h(b){var c=b||!1;n.loadData=!0,c||(n.deleteId=null),a.getAll(n.filter.name,n.filter.username,n.currentPage).then(function(a){n.loadData=!1,n.users=a.users,n.totalPage=a.total})}function i(b){function d(){n.formSuccess=!0,c(function(){g(),h()},600)}n.formError=null,n.processing=!0,b.id?a.update(b).then(function(){d()},function(a){n.formError=a.data.message,n.processing=!1}):a.create(b).then(function(){d()},function(a){n.formError=a.data.message,n.processing=!1})}function j(){b.getAll().then(function(a){n.roles=a.roles})}function k(a){e(),c(function(){n.selectedUser=angular.copy(a),a.Roles&&a.Roles[0]&&(n.selectedUser.roleId=a.Roles[0].id),delete n.selectedUser.Roles})}function l(b){n.deleteId=b,a["delete"](b).then(function(a){a.success&&h(!0)})}function m(){a.undelete(n.deleteId).then(function(a){a.success&&h()})}var n=this;n.selectedUser={},n.selectedUser.isActive=!0,n.currentPage=1,d(),j(),h(),n.undoDelete=m,n.editUser=k,n.getForm=f,n.closeForm=g,n.refresh=h,n.submitForm=i,n.clrFilter=d,n.deleteUser=l}]),angular.module("angularApp").controller("ServicesCtrl",["Service","Role","$timeout",function(a,b,c){function d(a){for(var b=angular.copy(a),c=[],d=2;b.length>0;)c.push(b.splice(0,d));return c}function e(){p.filter={},p.filter.name="",p.filter.username=""}function f(){p.showForm=!0,p.formError=null,p.formSuccess=null}function g(){f()}function h(){p.showForm=!1,p.selectedData={},p.processing=!1}function i(b){var c=b||!1;p.loadData=!0,c||(p.deleteId=null),a.getAll(p.filter.name,p.currentPage).then(function(a){if(p.loadData=!1,p.services=a.services,p.services&&p.services.length)for(var b=0;b<p.services.length;b++)p.services[b].Tasks&&p.services[b].Tasks.length&&(p.services[b].chunkTasks=d(p.services[b].Tasks));p.totalPage=a.total})}function j(b){function d(){p.formSuccess=!0,c(function(){h(),i()},600)}if(p.formError=null,p.processing=!0,!b.isPackage){b.price=0;for(var e=0;e<b.Tasks.length;e++)b.price+=isNaN(parseInt(b.Tasks[e].price))?0:parseInt(b.Tasks[e].price)}b.id?a.update(b).then(function(){d()},function(a){p.formError=a.data.message,p.processing=!1}):a.create(b).then(function(){d()},function(a){p.formError=a.data.message,p.processing=!1})}function k(a){f(),c(function(){p.selectedData=angular.copy(a),delete p.selectedData.Roles})}function l(b){p.deleteId=b,a["delete"](b).then(function(a){a.success&&i(!0)})}function m(){a.undelete(p.deleteId).then(function(a){a.success&&i()})}function n(){p.selectedData.Tasks||(p.selectedData.Tasks=[]),p.selectedData.Tasks.push({name:"",price:0})}function o(a){p.selectedData.Tasks.length&&p.selectedData.Tasks.splice(a,1)}var p=this;p.selectedData={},p.currentPage=1,e(),i(),p.removeTask=o,p.addTask=n,p.undoDelete=m,p.edit=k,p.getForm=g,p.closeForm=h,p.refresh=i,p.submitForm=j,p.clrFilter=e,p["delete"]=l}]),angular.module("angularApp").factory("Authentication",["Restangular",function(a){return{authenticate:function(b){return a.all("authenticate").customPOST(b,null,{},{})}}}]),angular.module("angularApp").factory("Authorization",["$rootScope","$state","Cancan",function(a,b,c){return{authorize:function(){return c.identity().then(function(){var d=c.isAuthenticated();void 0!==a.toState.data&&a.toState.data.roles&&a.toState.data.roles.length>0&&!c.isInAnyRole(a.toState.data.roles)&&(d?b.go("app.restricted.dashboard"):(a.returnToState=a.toState,a.returnToStateParams=a.toStateParams,b.go("auth")))})}}}]),angular.module("angularApp").factory("Cancan",["$q","$http","User",function(a,b,c){var d=void 0,e=!1;return{isIdentityResolved:function(){return angular.isDefined(d)},isAuthenticated:function(){return e},isInRole:function(a){return e&&d.roles?-1!==d.roles.indexOf(a):!1},isInAnyRole:function(a){if(!d)return!1;if(!e||!d.roles)return!1;for(var b=0;b<a.length;b++)if(this.isInRole(a[b]))return!0;return!1},authenticate:function(a){d=a,e=null!==a},identity:function(b){var f=a.defer();return b===!0&&(d=void 0),angular.isDefined(d)?(f.resolve(d),f.promise):(c.me().then(function(a){d=a.user,e=!0,f.resolve(d)},function(){d=null,e=!1,f.resolve(d)}),f.promise)}}}]),angular.module("angularApp").factory("User",["Restangular",function(a){return{me:function(){return a.one("users/me").get()},create:function(b){return a.all("users/create").customPOST({user:b},null,{},{})},update:function(b){return a.all("users/update").customPOST({user:b},null,{},{})},"delete":function(b){return a.all("users").customDELETE("delete?userId="+b,{})},undelete:function(b){return a.all("users/undelete").customPOST({userId:b},null,{},{})},getAll:function(b,c,d){return a.one("users/all?filterName="+b+"&filterUsername="+c+"&page="+d).get()}}}]),angular.module("angularApp").factory("Role",["Restangular",function(a){return{getAll:function(){return a.one("roles/all").get()}}}]),angular.module("angularApp").factory("Service",["Restangular",function(a){return{me:function(){return a.one("services/me").get()},create:function(b){return a.all("services/create").customPOST({service:b},null,{},{})},update:function(b){return a.all("services/update").customPOST({service:b},null,{},{})},"delete":function(b){return a.all("services").customDELETE("delete?id="+b,{})},undelete:function(b){return a.all("services/undelete").customPOST({id:b},null,{},{})},getAll:function(b,c){return a.one("services/all?filterName="+b+"&page="+c).get()}}}]),angular.module("angularApp").config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/dashboard"),b.when("","/dashboard"),a.state("auth",{url:"/login",templateUrl:"views/auth/index.html",controller:"AuthCtrl",controllerAs:"vm"}).state("app",{url:"","abstract":!0,templateUrl:"views/layouts/application.html",controller:"MainCtrl",params:{token:null},resolve:{currentUser:["Cancan",function(a){return a.identity(!0)}]}}).state("app.restricted",{url:"","abstract":!0,templateUrl:"views/layouts/application.html",resolve:{authorize:["Authorization",function(a){return a.authorize()}]}}).state("app.restricted.dashboard",{url:"/dashboard",templateUrl:"views/dashboards/index.html",controllerAs:"vm",data:{roles:["superadmin","user"]}}).state("app.restricted.users",{url:"/users",templateUrl:"views/users/index.html",controller:"UsersCtrl",controllerAs:"vm",data:{roles:["superadmin"]}}).state("app.restricted.services",{url:"/services",templateUrl:"views/services/index.html",controller:"ServicesCtrl",controllerAs:"vm",data:{roles:["superadmin"]}})}]);